<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GIFs — Michael Mace</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="icon" href="/favicon.png" />
    <meta name="color-scheme" content="light dark" />
  </head>

  <body>
    <p class="nav-links">
      <a href="../index.html">Home</a> ·
      <a href="../notes/index.html">Notes</a> · <a href="index.html">GIFs</a> ·
      <a
        href="https://github.com/mmbmf1"
        target="_blank"
        rel="noopener noreferrer"
        >GitHub</a
      >
    </p>

    <h1 class="no-margin-bottom">GIFs <span id="gif-editor-wrap" class="hidden"><a id="gif-editor-link" href="/editor/gifs.html" class="local-edit" aria-label="Edit GIFs" title="Edit GIFs">&#9998;</a></span></h1>

    <div class="gif-rows" id="gif-rows"></div>

    <div id="toast" class="toast" role="status" aria-live="polite">copied</div>

    <script>
      const toast = document.getElementById('toast')
      let toastTimer = null

      const DEFAULT_LISTS = [
        { id: 'favs', label: 'favorites' },
        { id: 'others', label: 'these are good too' },
      ]
      const isLocal =
        /^localhost$|^127\.0\.0\.1$/.test(location.hostname) ||
        location.hostname === ''
      const EDITOR_PORT = 3002
      const editorOrigin =
        isLocal && String(location.port) !== String(EDITOR_PORT)
          ? location.protocol + '//' + location.hostname + ':' + EDITOR_PORT
          : ''

      function createCardForUrl(url, title, alt, youtubeUrl) {
        const card = document.createElement('div')
        card.className = 'gif-card'
        const img = document.createElement('img')
        img.className = 'gif'
        img.src = url
        img.setAttribute('data-gif', url)
        img.alt = alt || ''
        img.loading = 'lazy'
        if (title) img.setAttribute('data-title', title)
        const labels = document.createElement('div')
        labels.className = 'card-labels'
        labels.innerHTML =
          '<span class="card-label">click to copy</span>' +
          (youtubeUrl
            ? '<a class="card-label" href="' + youtubeUrl + '" target="_blank" rel="noopener" title="open on YouTube">view on youtube</a>'
            : '') +
          '<span class="card-label card-label-title"></span>'
        card.appendChild(img)
        card.appendChild(labels)
        return card
      }

      function createCardFromItem(item) {
        return createCardForUrl(
          item.url,
          item.title || '',
          item.alt || '',
          item.youtubeUrl || ''
        )
      }

      function normalizeItem(item) {
        const listId = (item && item.listId) || (item && item.favorite ? 'favs' : 'others')
        return {
          url: (item && item.url) || '',
          alt: (item && item.alt) || '',
          title: (item && item.title) || '',
          youtubeUrl: item && item.youtubeUrl,
          listId,
        }
      }

      function renderFromData(lists, items) {
        const container = document.getElementById('gif-rows')
        if (!container) return
        container.innerHTML = ''
        const normalized = (Array.isArray(items) ? items : []).map(normalizeItem)
        const listOrder = Array.isArray(lists) && lists.length > 0
          ? lists.filter((l) => l && l.id && l.label)
          : DEFAULT_LISTS.slice()
        listOrder.forEach((list) => {
          const listItems = normalized.filter((i) => i.listId === list.id)
          const wrap = document.createElement('div')
          wrap.className = 'gif-list-wrap'
          const label = document.createElement('p')
          label.className = 'gif-row-label'
          label.textContent = list.label
          const grid = document.createElement('div')
          grid.className = 'gif-grid'
          grid.setAttribute('role', 'region')
          grid.setAttribute('aria-label', list.label)
          listItems.forEach((item) => grid.appendChild(createCardFromItem(item)))
          wrap.appendChild(label)
          wrap.appendChild(grid)
          container.appendChild(wrap)
        })
        fillTitlePills()
        attachCopyHandlers()
      }

      function fillTitlePills() {
        document.querySelectorAll('.gif-card').forEach((card) => {
          const img = card.querySelector('.gif')
          const titleEl = card.querySelector('.card-label-title')
          const title = img && img.getAttribute('data-title')
          if (img && titleEl && title) titleEl.textContent = title
        })
      }

      function attachCopyHandlers() {
        document.querySelectorAll('img[data-gif]').forEach((img) => {
          img.onclick = async (e) => {
            e.preventDefault()
            e.stopPropagation()
            const url = img.getAttribute('data-gif')
            const md = `![](${url})`
            try {
              await copyText(md)
              showToast('copied markdown')
            } catch {
              showToast('copy failed')
            }
          }
        })
      }

      function showToast(text = 'copied') {
        toast.textContent = text
        toast.classList.add('show')
        clearTimeout(toastTimer)
        toastTimer = setTimeout(() => toast.classList.remove('show'), 900)
      }

      async function copyText(text) {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text)
          return
        }
        const ta = document.createElement('textarea')
        ta.value = text
        ta.style.position = 'fixed'
        ta.style.left = '-9999px'
        document.body.appendChild(ta)
        ta.select()
        document.execCommand('copy')
        ta.remove()
      }

      ;(async function init() {
        let lists = DEFAULT_LISTS.slice()
        let items = []
        if (isLocal && editorOrigin) {
          try {
            const res = await fetch(editorOrigin + '/api/gifs/data')
            if (res.ok) {
              const data = await res.json()
              if (Array.isArray(data.lists)) lists = data.lists
              if (Array.isArray(data.items)) items = data.items
            }
          } catch (_) {}
        }
        if (items.length === 0) {
          try {
            const dataUrl = new URL('data.json', location.href).href
            const res = await fetch(dataUrl)
            if (res.ok) {
              const data = await res.json()
              if (Array.isArray(data.lists)) lists = data.lists
              if (Array.isArray(data.items)) items = data.items
            }
          } catch (_) {}
        }
        renderFromData(lists, items)
        if (items.length === 0) {
          const container = document.getElementById('gif-rows')
          if (container) {
            const p = document.createElement('p')
            p.className = 'hint'
            p.textContent = 'No GIFs loaded. Check that data.json exists and is deployed.'
            container.appendChild(p)
          }
        }
        if (isLocal) {
          const wrap = document.getElementById('gif-editor-wrap')
          if (wrap) wrap.classList.remove('hidden')
          const link = document.getElementById('gif-editor-link')
          if (link && editorOrigin) link.href = editorOrigin + '/editor/gifs.html'
        }
      })()
    </script>
  </body>
</html>
