<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GIFs — Michael Mace</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="icon" href="/favicon.png" />
    <meta name="color-scheme" content="light dark" />
  </head>

  <body>
    <p class="nav-links">
      <a href="../index.html">Home</a> ·
      <a href="../notes/index.html">Notes</a> · <a href="index.html">GIFs</a> ·
      <a
        href="https://github.com/mmbmf1"
        target="_blank"
        rel="noopener noreferrer"
        >GitHub</a
      >
    </p>

    <h1 class="no-margin-bottom">GIFs <span id="gif-editor-wrap" class="hidden"><a id="gif-editor-link" href="/editor/gifs.html" class="local-edit" aria-label="Edit GIFs" title="Edit GIFs">&#9998;</a></span></h1>

    <div class="gif-rows">
      <div id="gif-favorites-wrap">
        <p class="gif-row-label">favorites</p>
        <div
          id="gif-row-favorites"
          class="gif-grid"
          role="region"
          aria-label="Favorite GIFs"
        ></div>
      </div>
      <div id="gif-others-wrap">
        <p class="gif-row-label">these are good too</p>
        <div
          id="gif-row-others"
          class="gif-grid"
          role="region"
          aria-label="GIF carousel"
        ></div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite">copied</div>

    <script>
      const toast = document.getElementById('toast')
      let toastTimer = null

      const MAX_FAVORITES = 10
      const isLocal =
        /^localhost$|^127\.0\.0\.1$/.test(location.hostname) ||
        location.hostname === ''
      const EDITOR_PORT = 3002
      const editorOrigin =
        isLocal && String(location.port) !== String(EDITOR_PORT)
          ? location.protocol + '//' + location.hostname + ':' + EDITOR_PORT
          : ''

      function createCardForUrl(url, title, alt, youtubeUrl) {
        const card = document.createElement('div')
        card.className = 'gif-card'
        const img = document.createElement('img')
        img.className = 'gif'
        img.src = url
        img.setAttribute('data-gif', url)
        img.alt = alt || ''
        img.loading = 'lazy'
        if (title) img.setAttribute('data-title', title)
        const labels = document.createElement('div')
        labels.className = 'card-labels'
        labels.innerHTML =
          '<span class="card-label">click to copy</span>' +
          (youtubeUrl
            ? '<a class="card-label" href="' + youtubeUrl + '" target="_blank" rel="noopener" title="open on YouTube">view on youtube</a>'
            : '') +
          '<span class="card-label card-label-title"></span>'
        card.appendChild(img)
        card.appendChild(labels)
        return card
      }

      function createCardFromItem(item) {
        return createCardForUrl(
          item.url,
          item.title || '',
          item.alt || '',
          item.youtubeUrl || ''
        )
      }

      function renderFromData(items) {
        const rowFav = document.getElementById('gif-row-favorites')
        const rowOthers = document.getElementById('gif-row-others')
        const wrap = document.getElementById('gif-favorites-wrap')
        if (!rowFav || !rowOthers) return
        const favorites = items.filter((i) => i.favorite).slice(0, MAX_FAVORITES)
        const others = items.filter((i) => !i.favorite)
        rowFav.innerHTML = ''
        rowOthers.innerHTML = ''
        favorites.forEach((item) => rowFav.appendChild(createCardFromItem(item)))
        others.forEach((item) => rowOthers.appendChild(createCardFromItem(item)))
        if (wrap) wrap.style.display = rowFav.children.length ? '' : 'none'
        fillTitlePills()
        attachCopyHandlers()
      }

      function fillTitlePills() {
        document.querySelectorAll('.gif-card').forEach((card) => {
          const img = card.querySelector('.gif')
          const titleEl = card.querySelector('.card-label-title')
          const title = img && img.getAttribute('data-title')
          if (img && titleEl && title) titleEl.textContent = title
        })
      }

      function attachCopyHandlers() {
        document.querySelectorAll('img[data-gif]').forEach((img) => {
          img.onclick = async (e) => {
            e.preventDefault()
            e.stopPropagation()
            const url = img.getAttribute('data-gif')
            const md = `![](${url})`
            try {
              await copyText(md)
              showToast('copied markdown')
            } catch {
              showToast('copy failed')
            }
          }
        })
      }

      function showToast(text = 'copied') {
        toast.textContent = text
        toast.classList.add('show')
        clearTimeout(toastTimer)
        toastTimer = setTimeout(() => toast.classList.remove('show'), 900)
      }

      async function copyText(text) {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text)
          return
        }
        const ta = document.createElement('textarea')
        ta.value = text
        ta.style.position = 'fixed'
        ta.style.left = '-9999px'
        document.body.appendChild(ta)
        ta.select()
        document.execCommand('copy')
        ta.remove()
      }

      ;(async function init() {
        let items = []
        if (isLocal && editorOrigin) {
          try {
            const res = await fetch(editorOrigin + '/api/gifs/data')
            if (res.ok) {
              const data = await res.json()
              if (Array.isArray(data.items)) items = data.items
            }
          } catch (_) {}
        }
        if (items.length === 0) {
          try {
            const res = await fetch('data.json')
            if (res.ok) {
              const data = await res.json()
              if (Array.isArray(data.items)) items = data.items
            }
          } catch (_) {}
        }
        renderFromData(items)
        if (isLocal) {
          const wrap = document.getElementById('gif-editor-wrap')
          if (wrap) wrap.classList.remove('hidden')
          const link = document.getElementById('gif-editor-link')
          if (link && editorOrigin) link.href = editorOrigin + '/editor/gifs.html'
        }
      })()
    </script>
  </body>
</html>
