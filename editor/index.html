<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Note editor — Michael Mace</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="icon" href="/favicon.png" />
    <meta name="color-scheme" content="light dark" />
    <style>
      #note-form input,
      #note-form textarea {
        font-size: 1rem;
        padding: 0.4rem 0.5rem;
        width: 100%;
        max-width: 36rem;
        box-sizing: border-box;
      }
      #note-form textarea {
        min-height: 16rem;
        resize: vertical;
      }
      #note-form button {
        margin-top: 1rem;
        font-size: 1rem;
        padding: 0.5rem 1rem;
      }
      #delete-wrap {
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid #ccc;
      }
      #delete-btn {
        background: #c00;
        color: #fff;
        border: none;
        padding: 0.35rem 0.75rem;
        font-size: 0.9rem;
        border-radius: 0.25rem;
        cursor: pointer;
      }
      #delete-btn:hover {
        background: #a00;
      }
      @media (prefers-color-scheme: dark) {
        #delete-wrap {
          border-color: #444;
        }
      }
    </style>
  </head>
  <body>
    <p class="nav-links">
      <a href="../index.html">Home</a> ·
      <a href="../notes/index.html">Notes</a> ·
      <a href="../gifs/index.html">GIFs</a>
      ·
      <a
        href="https://github.com/mmbmf1"
        target="_blank"
        rel="noopener noreferrer"
        >GitHub</a
      >
    </p>
    <h1>Note editor</h1>

    <form id="note-form">
      <p>
        <label for="title">Title</label><br />
        <input type="text" id="title" name="title" required />
      </p>
      <p>
        <label for="slug"
          >Url slug
          <em style="font-size: 0.7em"
            >(optional, derived from title if empty)</em
          ></label
        ><br />
        <input
          type="text"
          id="slug"
          name="slug"
          placeholder="e.g. on-layering-intel"
        />
      </p>
      <p>
        <label for="date">Date</label><br />
        <input type="text" id="date" name="date" />
      </p>
      <p>
        <label for="body">Body (markdown)</label><br />
        <textarea id="body" name="body" rows="20"></textarea>
      </p>
      <p>
        <button type="submit">Submit</button>
      </p>
    </form>

    <p id="message" aria-live="polite"></p>

    <p id="delete-wrap" style="display: none">
      <button type="button" id="delete-btn">Delete note</button>
    </p>

    <script>
      const form = document.getElementById('note-form')
      const messageEl = document.getElementById('message')
      const titleInput = document.getElementById('title')
      const slugInput = document.getElementById('slug')
      const dateInput = document.getElementById('date')
      const bodyInput = document.getElementById('body')

      function formatDateWithDay(date) {
        const days = [
          'Sunday',
          'Monday',
          'Tuesday',
          'Wednesday',
          'Thursday',
          'Friday',
          'Saturday',
        ]
        const months = [
          'January',
          'February',
          'March',
          'April',
          'May',
          'June',
          'July',
          'August',
          'September',
          'October',
          'November',
          'December',
        ]
        const d = date.getDate()
        const ord =
          d === 1 || d === 21 || d === 31
            ? 'st'
            : d === 2 || d === 22
            ? 'nd'
            : d === 3 || d === 23
            ? 'rd'
            : 'th'
        return (
          days[date.getDay()] +
          ' ' +
          months[date.getMonth()] +
          ' ' +
          d +
          ord +
          ' ' +
          date.getFullYear()
        )
      }

      dateInput.value = formatDateWithDay(new Date())
      let currentSlug = null
      ;(async function loadNoteFromQuery() {
        const params = new URLSearchParams(window.location.search)
        const slug = params.get('slug')
        if (!slug) return
        try {
          const res = await fetch('/api/note/' + encodeURIComponent(slug))
          if (!res.ok) {
            messageEl.textContent =
              res.status === 404 ? 'Note not found.' : 'Failed to load note.'
            return
          }
          const data = await res.json()
          currentSlug = data.slug
          document.getElementById('delete-wrap').style.display = ''
          titleInput.value = data.title || ''
          slugInput.value = data.slug || ''
          dateInput.value = data.date || formatDateWithDay(new Date())
          bodyInput.value = data.body || ''
        } catch (err) {
          messageEl.textContent = 'Request failed: ' + err.message
        }
      })()

      document
        .getElementById('delete-btn')
        .addEventListener('click', async function () {
          if (!currentSlug) return
          if (!confirm('Delete this note? This cannot be undone.')) return
          try {
            const res = await fetch(
              '/api/note/' + encodeURIComponent(currentSlug),
              { method: 'DELETE' }
            )
            if (!res.ok) {
              messageEl.textContent = 'Delete failed.'
              return
            }
            window.location.href = '/notes/'
          } catch (err) {
            messageEl.textContent = 'Request failed: ' + err.message
          }
        })

      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        messageEl.textContent = ''
        const title = titleInput.value.trim()
        const slug = slugInput.value.trim()
        const date = dateInput.value.trim()
        const body = bodyInput.value

        try {
          const res = await fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              slug: slug || undefined,
              date: date || formatDateWithDay(new Date()),
              body,
            }),
          })
          const data = await res.json().catch(() => ({}))
          if (!res.ok) {
            messageEl.textContent = data.error || 'Save failed.'
            return
          }
          messageEl.innerHTML =
            'Saved. <a href="../notes/' + data.slug + '.html">Open note</a>'
        } catch (err) {
          messageEl.textContent = 'Request failed: ' + err.message
        }
      })
    </script>
  </body>
</html>
