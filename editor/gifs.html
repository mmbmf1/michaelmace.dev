<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>GIF editor — Michael Mace</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="icon" href="/favicon.png" />
    <meta name="color-scheme" content="light dark" />
  </head>
  <body>
    <p class="nav-links">
      <a href="../index.html">Home</a> ·
      <a href="../notes/index.html">Notes</a> ·
      <a href="../gifs/index.html">GIFs</a>
      ·
      <a
        href="https://github.com/mmbmf1"
        target="_blank"
        rel="noopener noreferrer"
        >GitHub</a
      >
    </p>
    <h1 class="no-margin-bottom">GIF editor</h1>
    <p class="gif-row-label" style="margin-top: 0.5rem">All GIFs. Pick a list per item. Favorites list has max 10. Order is used on the GIFs page.</p>

    <p style="margin-bottom: 0.5rem">
      <button type="button" id="add-list-btn" disabled>Add list</button>
    </p>
    <div id="all-list" class="gif-grid" style="margin-top: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem"></div>

    <p style="margin-bottom: 1rem">
      <label for="paste-url">Add GIF: paste URL</label>
      <input type="url" id="paste-url" placeholder="https://..." style="width: 100%; max-width: 28rem; padding: 0.4rem; box-sizing: border-box" />
      <button type="button" id="paste-add-btn" style="margin-top: 0.35rem">Add</button>
    </p>
    <p>
      <button type="button" id="save-btn">Save</button>
    </p>
    <p id="message" aria-live="polite" style="margin-top: 1rem"></p>

    <script>
      const MAX_FAVORITES = 10
      const DEFAULT_LISTS = [
        { id: 'favs', label: 'favorites' },
        { id: 'others', label: 'these are good too' },
      ]
      const EDITOR_PORT = 3002
      const isLocal = /^localhost$|^127\.0\.0\.1$/.test(location.hostname) || location.hostname === ''
      const apiBase = isLocal && String(location.port) !== String(EDITOR_PORT) ? location.protocol + '//' + location.hostname + ':' + EDITOR_PORT : ''
      const allList = document.getElementById('all-list')
      const addListBtn = document.getElementById('add-list-btn')
      const pasteUrl = document.getElementById('paste-url')
      const pasteAddBtn = document.getElementById('paste-add-btn')
      const saveBtn = document.getElementById('save-btn')
      const messageEl = document.getElementById('message')

      let lists = DEFAULT_LISTS.slice()
      let items = []

      function setMessage(text, isError) {
        messageEl.textContent = text
        messageEl.style.color = isError ? '#c00' : ''
      }

      function listIdForItem(item) {
        if (item && typeof item.listId === 'string' && item.listId.trim()) return item.listId.trim()
        return item && item.favorite ? 'favs' : 'others'
      }

      function favCount() {
        return items.filter((i) => listIdForItem(i) === 'favs').length
      }

      function ensureListId(item) {
        if (!item.listId) item.listId = item.favorite ? 'favs' : 'others'
      }

      function renderList() {
        allList.innerHTML = ''
        items.forEach((item, i) => {
          ensureListId(item)
          const listId = listIdForItem(item)
          item.listId = listId
          const card = document.createElement('div')
          card.className = 'gif-card'
          card.style.marginBottom = '0.5rem'
          const img = document.createElement('img')
          img.className = 'gif'
          img.src = item.url
          img.alt = item.alt || ''
          img.setAttribute('data-gif', item.url)
          if (item.title) img.setAttribute('data-title', item.title)
          card.appendChild(img)
          const controls = document.createElement('div')
          controls.style.marginTop = '0.35rem'
          const listSelect = document.createElement('select')
          listSelect.style.fontSize = '0.85rem'
          listSelect.style.marginRight = '0.35rem'
          lists.forEach((l) => {
            const opt = document.createElement('option')
            opt.value = l.id
            opt.textContent = l.label
            if (l.id === listId) opt.selected = true
            listSelect.appendChild(opt)
          })
          listSelect.addEventListener('change', () => {
            const newId = (listSelect.value || '').trim() || 'others'
            const currentId = (listId || listIdForItem(item) || 'others').trim()
            const wouldAddToFavs = newId === 'favs' && currentId !== 'favs'
            const favsAfter = favCount() + (wouldAddToFavs ? 1 : 0)
            if (newId === 'favs' && favsAfter > MAX_FAVORITES) {
              setMessage('Max 10 in favorites', true)
              listSelect.value = currentId
              return
            }
            item.listId = newId
            setMessage('')
          })
          const removeBtn = document.createElement('button')
          removeBtn.type = 'button'
          removeBtn.textContent = 'Remove'
          removeBtn.style.fontSize = '0.85rem'
          removeBtn.style.marginLeft = '0.2rem'
          removeBtn.addEventListener('click', () => {
            items.splice(i, 1)
            renderList()
            setMessage('')
          })
          const upBtn = document.createElement('button')
          upBtn.type = 'button'
          upBtn.textContent = '↑'
          upBtn.style.marginLeft = '0.35rem'
          upBtn.disabled = i === 0
          upBtn.addEventListener('click', () => {
            ;[items[i - 1], items[i]] = [items[i], items[i - 1]]
            renderList()
            setMessage('')
          })
          const downBtn = document.createElement('button')
          downBtn.type = 'button'
          downBtn.textContent = '↓'
          downBtn.style.marginLeft = '0.2rem'
          downBtn.disabled = i === items.length - 1
          downBtn.addEventListener('click', () => {
            ;[items[i], items[i + 1]] = [items[i + 1], items[i]]
            renderList()
            setMessage('')
          })
          const titleLabel = document.createElement('label')
          titleLabel.style.display = 'block'
          titleLabel.style.marginTop = '0.25rem'
          titleLabel.style.fontSize = '0.8rem'
          titleLabel.textContent = 'Title'
          const titleInput = document.createElement('input')
          titleInput.type = 'text'
          titleInput.value = item.title || ''
          titleInput.placeholder = 'optional'
          titleInput.style.width = '100%'
          titleInput.style.maxWidth = '100%'
          titleInput.style.padding = '0.25rem'
          titleInput.style.boxSizing = 'border-box'
          titleInput.style.fontSize = '0.9rem'
          titleInput.addEventListener('change', () => { item.title = titleInput.value.trim() })
          titleInput.addEventListener('blur', () => { item.title = titleInput.value.trim() })
          controls.appendChild(listSelect)
          controls.appendChild(removeBtn)
          controls.appendChild(upBtn)
          controls.appendChild(downBtn)
          card.appendChild(controls)
          card.appendChild(titleLabel)
          card.appendChild(titleInput)
          allList.appendChild(card)
        })
      }

      function addItem(url, alt = '', title = '') {
        const u = (url || '').trim()
        if (!u) return
        if (items.some((i) => i.url === u)) {
          setMessage('Already in list', true)
          return
        }
        items.push({ url: u, alt, title, listId: 'others' })
        renderList()
        setMessage('')
      }

      if (!addListBtn) {
        setMessage('Add list button not found', true)
      }
      addListBtn && addListBtn.addEventListener('click', () => {
        const name = window.prompt('New list name')
        if (!name || !name.trim()) return
        const label = name.trim()
        let id = label.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
        if (!id) id = 'list-' + Date.now()
        if (lists.some((l) => l.id === id)) {
          setMessage('A list with that name already exists', true)
          return
        }
        lists.push({ id: String(id), label: String(label) })
        renderList()
        setMessage('Added list: ' + label)
      })

      pasteAddBtn.addEventListener('click', () => {
        addItem(pasteUrl.value)
        pasteUrl.value = ''
      })
      saveBtn.addEventListener('click', async () => {
        setMessage('')
        try {
          items.forEach(ensureListId)
          const payload = {
            lists: lists.map((l) => ({ id: String(l.id), label: String(l.label) })),
            items: items.map((i) => ({ url: i.url, alt: i.alt || '', title: i.title || '', listId: String(i.listId || 'others') })),
          }
          const res = await fetch(apiBase + '/api/gifs/data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
          const data = await res.json().catch(() => ({}))
          if (!res.ok) {
            const msg = data.detail ? data.error + ': ' + data.detail : (data.error || 'Save failed')
            setMessage(msg + ' (' + res.status + ')', true)
            return
          }
          setMessage('Saved.')
        } catch (err) {
          setMessage('Request failed: ' + err.message + '. Is the editor server running on port 3002?', true)
        }
      })

      ;(async function load() {
        setMessage('Loading…')
        try {
          const res = await fetch(apiBase + '/api/gifs/data')
          const data = await res.json().catch(() => ({}))
          const serverLists = Array.isArray(data.lists) && data.lists.length > 0 ? data.lists : DEFAULT_LISTS.slice()
          const serverItems = Array.isArray(data.items) ? data.items : []
          if (serverItems.length === 0) {
            const [listRes, favRes] = await Promise.all([fetch(apiBase + '/api/gifs/list'), fetch(apiBase + '/api/gifs/favorites')])
            const list = await listRes.json().catch(() => [])
            const favData = await favRes.json().catch(() => ({}))
            const favUrls = new Set((favData.favorites || []).slice(0, MAX_FAVORITES))
            items = list.map((g) => ({ url: g.url, alt: g.alt || '', title: g.title || '', listId: favUrls.has(g.url) ? 'favs' : 'others' }))
          } else {
            items = serverItems
          }
          items.forEach(ensureListId)
          if (serverLists.length >= lists.length) {
            lists = serverLists
          } else if (lists.length <= DEFAULT_LISTS.length) {
            lists = serverLists
          }
          if (!lists.some((l) => l && l.id === 'favs')) {
            lists = [DEFAULT_LISTS[0], ...lists.filter((l) => l && l.id !== 'favs')]
          }
          if (!lists.some((l) => l && l.id === 'others')) {
            lists = [...lists.filter((l) => l && l.id !== 'others'), DEFAULT_LISTS[1]]
          }
          renderList()
          if (addListBtn) addListBtn.disabled = false
          setMessage('')
        } catch (err) {
          setMessage('Load failed: ' + err.message, true)
          if (addListBtn) addListBtn.disabled = false
        }
      })()
    </script>
  </body>
</html>
